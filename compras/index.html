<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>Mercado Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6b7280;
            --success: #84cc16;
            --danger: #f87171;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #e5e5e5;
            --gray-300: #d4d4d4;
            --gray-400: #a3a3a3;
            --gray-600: #737373;
            --gray-700: #525252;
            --gray-900: #262626;
        }

        body {
            font-family: "Poppins", sans-serif;
            background: var(--gray-50);
            min-height: 100vh;
            color: var(--gray-900);
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s ease;
        }

        h1,
        h2,
        h3,
        h4 {
            font-family: "Montserrat", sans-serif;
            transition: color 0.3s ease;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .app-header {
            margin-bottom: 28px;
            padding-bottom: 16px;
            transition: all 0.3s ease;
        }

        .app-header h1 {
            font-size: 1.375rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 4px;
            text-align: center;
            transition: transform 0.3s ease, color 0.3s ease;
        }

        .app-header p {
            font-size: 0.875rem;
            color: var(--gray-600);
            font-weight: 400;
            text-align: center;
            transition: color 0.3s ease;
        }

        /* Painel Financeiro */
        .painel-financeiro {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .stats-card {
            background: white;
            padding: 14px 16px;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .stats-card.total {
            background: var(--gray-900);
            color: white;
            border-color: var(--gray-900);
        }

        .stats-card.saldo {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .stats-card.saldo.negativo {
            background: var(--danger);
            border-color: var(--danger);
            animation: shake 0.5s ease;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }

        .stats-label {
            font-size: 0.6875rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.75;
            margin-bottom: 4px;
            transition: opacity 0.3s ease;
        }

        .stats-value {
            font-size: 1.375rem;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            transition: transform 0.3s ease;
        }

        /* Cards */
        .card {
            background: white;
            padding: 20px;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            transition: all 0.3s ease;
        }

        .card-header h3 {
            font-size: 0.9375rem;
            font-weight: 500;
            color: var(--gray-900);
        }

        .badge {
            background: var(--gray-200);
            color: var(--gray-700);
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.6875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        /* Inputs */
        input {
            width: 100%;
            padding: 11px 12px;
            margin-bottom: 10px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }

        input:focus {
            outline: none;
            border-color: var(--gray-400);
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        input::placeholder {
            color: var(--gray-400);
            transition: color 0.3s ease;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 10px;
        }

        .input-group {
            position: relative;
        }

        /* Buttons */
        button {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            background: white;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: var(--gray-900);
            color: white;
            border-color: var(--gray-900);
        }

        .btn-primary:hover {
            background: var(--gray-700);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border-color: var(--success);
            margin-top: 10px;
        }

        .btn-success:hover {
            background: #73b611;
        }

        .btn-danger {
            background: white;
            color: var(--danger);
            border-color: var(--gray-200);
            margin-top: 10px;
        }

        .btn-danger:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        /* Material Icons */
        .material-icons {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        button:hover .material-icons {
            transform: scale(1.1);
        }

        button .material-icons {
            font-size: 20px;
        }

        /* Lista de Itens */
        .item-lista {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-100);
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .item-lista:hover {
            background: var(--gray-50);
            margin: 0 -10px;
            padding: 10px 10px;
            border-radius: 8px;
        }

        .item-lista:last-child {
            border-bottom: none;
        }

        .item-icon {
            display: none;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-nome {
            font-weight: 500;
            color: var(--gray-900);
            font-size: 0.9375rem;
            margin-bottom: 2px;
            transition: color 0.3s ease;
        }

        .item-detalhes {
            font-size: 0.8125rem;
            color: var(--gray-600);
            transition: color 0.3s ease;
        }

        .item-total {
            font-weight: 500;
            font-size: 0.9375rem;
            color: var(--gray-900);
            margin-right: 10px;
            transition: all 0.3s ease;
        }

        .btn-remove {
            width: 26px;
            height: 26px;
            padding: 0;
            background: var(--gray-100);
            color: var(--gray-600);
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            min-width: 26px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-remove .material-icons {
            font-size: 18px;
        }

        .btn-remove:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg) scale(1.1);
        }

        .btn-remove:active {
            transform: rotate(90deg) scale(0.95);
        }

        /* Chips Pendentes */
        .area-pendentes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .chip-pendente {
            padding: 7px 12px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            border-radius: 10px;
            font-size: 0.8125rem;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .chip-pendente .material-icons {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .chip-pendente:hover {
            background: var(--gray-900);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .chip-pendente:hover .material-icons {
            transform: rotate(360deg);
        }

        .chip-pendente:active {
            transform: translateY(0) scale(0.95);
        }

        /* Lista Suspensa */
        .lista-suspensa {
            position: absolute;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 500;
            top: calc(100% + 4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: dropDown 0.3s ease;
        }

        @keyframes dropDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .item-sugestao {
            padding: 11px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
            font-size: 0.9375rem;
            transition: all 0.2s ease;
        }

        .item-sugestao:last-child {
            border-bottom: none;
        }

        .item-sugestao:hover {
            background: var(--gray-50);
            padding-left: 16px;
        }

        .item-sugestao:active {
            background: var(--gray-100);
        }

        /* Histórico */
        .historico-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--gray-100);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .historico-card:last-child {
            border-bottom: none;
        }

        .historico-card:hover {
            background: var(--gray-50);
            margin: 0 -10px;
            padding: 10px 10px;
            border-radius: 8px;
            transform: translateX(5px);
        }

        .historico-card:active {
            transform: translateX(0) scale(0.98);
        }

        .historico-data {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--gray-600);
            font-size: 0.8125rem;
            transition: all 0.3s ease;
        }

        .historico-data .material-icons {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .historico-card:hover .historico-data .material-icons {
            transform: rotate(360deg);
        }

        .historico-total {
            font-weight: 500;
            font-size: 0.9375rem;
            color: var(--gray-900);
            transition: all 0.3s ease;
        }

        .historico-card:hover .historico-total {
            transform: scale(1.1);
            color: var(--success);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeInModal 0.3s ease;
            backdrop-filter: blur(4px);
            transition: backdrop-filter 0.3s ease;
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
        }

        .modal-header h2 {
            font-size: 1.0625rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-header h2 .material-icons {
            font-size: 24px;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .close-modal {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--gray-600);
            padding: 0;
            min-width: 26px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .close-modal .material-icons {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .close-modal:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .close-modal:active {
            transform: rotate(90deg) scale(0.9);
        }

        .linha-cupom {
            display: flex;
            justify-content: space-between;
            padding: 9px 0;
            border-bottom: 1px solid var(--gray-100);
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.8125rem;
            transition: all 0.3s ease;
            animation: slideInLeft 0.3s ease;
            animation-fill-mode: both;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .linha-cupom:nth-child(1) {
            animation-delay: 0.1s;
        }

        .linha-cupom:nth-child(2) {
            animation-delay: 0.15s;
        }

        .linha-cupom:nth-child(3) {
            animation-delay: 0.2s;
        }

        .linha-cupom:nth-child(4) {
            animation-delay: 0.25s;
        }

        .linha-cupom:nth-child(5) {
            animation-delay: 0.3s;
        }

        .linha-cupom:hover {
            background: var(--gray-50);
            padding-left: 8px;
            padding-right: 8px;
            border-radius: 4px;
        }

        .total-cupom {
            text-align: right;
            font-weight: 500;
            font-size: 1.0625rem;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--gray-900);
            animation: fadeIn 0.5s ease 0.3s;
            animation-fill-mode: both;
        }

        /* Notificações */
        #container-notificacoes {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            background: white;
            color: var(--gray-900);
            padding: 12px 14px;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            font-size: 0.8125rem;
            pointer-events: auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transition: all 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .toast .material-icons {
            font-size: 18px;
            animation: pulse 2s ease infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .toast.positivo {
            border-left: 3px solid var(--success);
        }

        .toast.negativo {
            border-left: 3px solid var(--danger);
        }

        .toast.neutro {
            border-left: 3px solid var(--gray-400);
        }

        /* Alert */
        .alert {
            padding: 11px;
            border-radius: 10px;
            margin-bottom: 14px;
            font-size: 0.8125rem;
            border: 1px solid var(--gray-200);
            background: var(--gray-100);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease;
            transition: all 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert .material-icons {
            font-size: 18px;
            animation: wiggle 2s ease infinite;
        }

        @keyframes wiggle {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-5deg);
            }

            75% {
                transform: rotate(5deg);
            }
        }

        .alert-info {
            background: #f0f9ff;
            border-color: #bae6fd;
            color: var(--gray-700);
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-muted {
            color: var(--gray-600);
        }

        .empty-state {
            text-align: center;
            padding: 44px 20px;
            color: var(--gray-400);
            animation: fadeIn 0.5s ease;
        }

        .empty-state-icon {
            font-size: 2.25rem;
            margin-bottom: 8px;
            opacity: 0.4;
            animation: float 3s ease infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .divider {
            height: 1px;
            background: var(--gray-200);
            margin: 18px 0;
            transition: all 0.3s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 10px;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* Responsive */
        @media (max-width: 400px) {
            .container {
                padding: 16px;
            }
        }

        /* Animações de entrada de tela */
        #tela-inicial,
        #tela-editor-lista,
        #tela-compras {
            animation: pageSlide 0.4s ease;
        }

        @keyframes pageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div id="container-notificacoes"></div>

    <div class="container">

        <!-- TELA INICIAL -->
        <div id="tela-inicial">
            <div class="app-header">
                <h1>Mercado Inteligente</h1>
                <p>Controle suas compras com facilidade</p>
            </div>

            <div class="card">
                <div id="aviso-recuperacao" class="alert alert-info hidden">
                    <span class="material-icons">info</span>
                    <span>Recuperamos sua compra em andamento!</span>
                </div>

                <button id="btn-criar-lista" class="btn-primary">
                    <span class="material-icons">edit_note</span>
                    <span>Editar Lista de Compras</span>
                </button>

                <div class="divider"></div>

                <label
                    style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; font-weight: 500; font-size: 0.875rem;">
                    <span class="material-icons" style="font-size: 18px;">account_balance_wallet</span>
                    Limite de orçamento
                </label>
                <input type="number" id="orcamento-inicial" placeholder="R$ 0,00" step="0.01" inputmode="decimal">
                <button id="btn-iniciar" class="btn-success">
                    <span class="material-icons">play_arrow</span>
                    <span>Iniciar Compras</span>
                </button>
            </div>

            <div class="card-header">
                <span class="material-icons">history</span>
                <h3>Compras Recentes</h3>
            </div>
            <div id="lista-historico"></div>
        </div>

        <!-- TELA EDITOR DE LISTA -->
        <div id="tela-editor-lista" class="hidden">
            <div class="app-header">
                <h1>Lista de Compras</h1>
                <p>Organize o que você precisa</p>
            </div>

            <div class="card">
                <div class="input-group" style="position: relative;">
                    <input type="text" id="input-item-lista" placeholder="Ex: Arroz, Leite..." autocomplete="off">
                    <div id="lista-sugestoes-editor" class="lista-suspensa hidden"></div>
                </div>

                <button id="btn-add-item-lista" class="btn-primary">
                    <span class="material-icons">add</span>
                    <span>Adicionar Item</span>
                </button>

                <div class="divider"></div>

                <div id="lista-previa-itens"></div>

                <button id="btn-salvar-lista" class="btn-success">
                    <span class="material-icons">save</span>
                    <span>Salvar e Voltar</span>
                </button>
            </div>
        </div>

        <!-- TELA DE COMPRAS -->
        <div id="tela-compras" class="hidden">
            <div class="painel-financeiro">
                <div class="stats-card total">
                    <div class="stats-label">Total Gasto</div>
                    <div class="stats-value">R$ <span id="txt-total">0,00</span></div>
                </div>
                <div id="box-saldo" class="stats-card saldo">
                    <div class="stats-label" id="label-saldo">Saldo Restante</div>
                    <div class="stats-value">R$ <span id="txt-saldo">0,00</span></div>
                </div>
            </div>

            <div id="painel-lista-pendente" class="card hidden">
                <div class="card-header">
                    <h3>Falta Comprar</h3>
                    <span class="badge" id="badge-pendentes">0</span>
                </div>
                <input type="text" id="busca-pendente" placeholder="Procurar na lista..." style="margin-bottom: 0;">
                <div id="area-pendentes" class="area-pendentes"></div>
            </div>

            <div class="card">
                <div class="input-group" style="position: relative;">
                    <input type="text" id="input-nome" placeholder="Nome do produto" autocomplete="off">
                    <div id="lista-sugestoes" class="lista-suspensa hidden"></div>
                </div>

                <div class="input-row">
                    <input type="number" id="input-qtd" placeholder="Qtd" value="1" min="1" max="50" step="1"
                        inputmode="numeric">
                    <input type="number" id="input-preco" placeholder="Preço unitário" step="0.01" inputmode="decimal">
                </div>

                <button id="btn-adicionar" class="btn-primary">
                    <span class="material-icons">add_shopping_cart</span>
                    <span>Adicionar ao Carrinho</span>
                </button>
            </div>

            <div id="lista-atual" class="card"></div>

            <button id="btn-finalizar" class="btn-success">
                <span class="material-icons">check_circle</span>
                <span>Finalizar Compra</span>
            </button>
            <button id="btn-cancelar" class="btn-danger">
                <span class="material-icons">cancel</span>
                <span>Cancelar Tudo</span>
            </button>
        </div>

    </div>

    <!-- MODAL CUPOM -->
    <div id="modal-cupom" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <span class="material-icons">receipt</span>
                    Cupom Fiscal
                </h2>
                <button class="close-modal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div id="conteudo-cupom"></div>
            <div id="total-cupom" class="total-cupom"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAFvUYHdaNItt6zAbLaYxafzjifRkP0UU",
            authDomain: "compras-158d1.firebaseapp.com",
            projectId: "compras-158d1",
            storageBucket: "compras-158d1.firebasestorage.app",
            messagingSenderId: "740402019679",
            appId: "1:740402019679:web:e3a996f6844ac0f698caea"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ESTADO & PERSISTÊNCIA ---
        let carrinho = [];
        let listaPrevia = [];
        let orcamento = 0;
        let ultimosPrecos = {};

        const salvarEstadoLocal = () => {
            const estado = {
                carrinho: carrinho,
                listaPrevia: listaPrevia,
                orcamento: orcamento,
                timestamp: Date.now()
            };
            localStorage.setItem('mercado_estado_temp', JSON.stringify(estado));
        };

        const carregarEstadoLocal = () => {
            const salvo = localStorage.getItem('mercado_estado_temp');
            if (salvo) {
                const estado = JSON.parse(salvo);
                carrinho = estado.carrinho || [];
                listaPrevia = estado.listaPrevia || [];
                orcamento = estado.orcamento || 0;

                if (carrinho.length > 0 || orcamento > 0) {
                    document.getElementById('orcamento-inicial').value = orcamento;
                    if (carrinho.length > 0) {
                        document.getElementById('aviso-recuperacao').classList.remove('hidden');
                    }
                }
            }
        };

        const limparEstadoLocal = () => {
            carrinho = [];
            orcamento = 0;
            salvarEstadoLocal();
        };

        const produtosBasicos = [
            "Arroz Branco", "Arroz Integral", "Feijão Carioca", "Feijão Preto", "Açúcar Refinado",
            "Açúcar Mascavo", "Sal Refinado", "Sal Grosso", "Café em Pó", "Cápsulas de Café",
            "Óleo de Soja", "Azeite de Oliva", "Vinagre", "Molho de Tomate", "Macarrão Espaguete",
            "Macarrão Parafuso", "Farinha de Trigo", "Farinha de Mandioca", "Milho de Pipoca",
            "Extrato de Tomate", "Maionese", "Ketchup", "Mostarda", "Leite Condensado", "Creme de Leite",
            "Pão Francês", "Pão de Forma", "Pão Integral", "Biscoito Recheado", "Biscoito Salgado",
            "Torrada", "Cereal Matinal", "Geléia", "Mel", "Achocolatado em Pó", "Aveia",
            "Leite Integral", "Leite Desnatado", "Leite de Soja", "Manteiga com Sal", "Margarina",
            "Queijo Mussarela", "Queijo Prato", "Queijo Parmesão", "Requeijão", "Iogurte Natural",
            "Iogurte de Frutas", "Ovos Brancos", "Ovos Caipiras", "Presunto", "Peito de Peru",
            "Frango (Peito)", "Frango (Coxa e Sobrecoxa)", "Carne Moída", "Bife de Alcatra",
            "Bife de Contra Filé", "Linguiça Toscana", "Salsicha", "Peixe Filé", "Bacon",
            "Batata Inglesa", "Batata Doce", "Cebola", "Alho", "Tomate", "Alface", "Cenoura",
            "Abobrinha", "Banana Prata", "Banana Nanica", "Maçã Gala", "Maçã Argentina",
            "Laranja", "Limão Taiti", "Mamão", "Melancia", "Uva", "Abacaxi",
            "Água Mineral", "Água com Gás", "Refrigerante de Cola", "Refrigerante de Guaraná",
            "Suco de Caixa", "Suco Concentrado", "Cerveja Latão", "Vinho Tinto", "Vinho Branco",
            "Detergente Líquido", "Sabão em Pó", "Sabão Líquido", "Amaciante", "Água Sanitária",
            "Desinfetante", "Limpador Multiuso", "Esponja de Aço", "Esponja de Louça", "Saco de Lixo",
            "Papel Higiênico", "Sabonete", "Shampoo", "Condicionador", "Pasta de Dente",
            "Escova de Dente", "Desodorante Roll-on", "Desodorante Aerossol", "Fio Dental",
            "Algodão", "Hastes Flexíveis", "Absorvente"
        ];
        let produtosConhecidos = new Set(produtosBasicos);

        // --- FUNÇÕES ---

        window.removerItem = (index) => {
            carrinho.splice(index, 1);
            salvarEstadoLocal();
            atualizarUI();
        };

        const atualizarUI = () => {
            const listaDiv = document.getElementById('lista-atual');
            const totalGeral = carrinho.reduce((sum, item) => sum + item.total, 0);
            const saldo = orcamento - totalGeral;

            document.getElementById('txt-total').innerText = totalGeral.toFixed(2).replace('.', ',');
            document.getElementById('txt-saldo').innerText = Math.abs(saldo).toFixed(2).replace('.', ',');

            const boxSaldo = document.getElementById('box-saldo');
            const labelSaldo = document.getElementById('label-saldo');

            if (saldo < 0) {
                boxSaldo.classList.add('negativo');
                labelSaldo.innerText = "Ultrapassou";
            } else {
                boxSaldo.classList.remove('negativo');
                labelSaldo.innerText = "Saldo Restante";
            }

            if (carrinho.length === 0) {
                listaDiv.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">shopping_cart</span>
                        <p>Carrinho vazio</p>
                    </div>
                `;
            } else {
                listaDiv.innerHTML = carrinho.map((item, i) => `
                    <div class="item-lista">
                        <div class="item-info">
                            <div class="item-nome">${item.nome}</div>
                            <div class="item-detalhes">${item.qtd}x R$ ${item.preco.toFixed(2).replace('.', ',')}</div>
                        </div>
                        <div class="item-total">R$ ${item.total.toFixed(2).replace('.', ',')}</div>
                        <button class="btn-remove" onclick="removerItem(${i})">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                `).reverse().join('');
            }

            atualizarListaPendenteVisual();
        };

        const inputBuscaPendente = document.getElementById('busca-pendente');
        inputBuscaPendente.addEventListener('input', () => {
            atualizarListaPendenteVisual();
        });

        const atualizarListaPendenteVisual = () => {
            const divPendentes = document.getElementById('area-pendentes');
            const painelPendentes = document.getElementById('painel-lista-pendente');
            const badgePendentes = document.getElementById('badge-pendentes');
            const termoBusca = inputBuscaPendente.value.toLowerCase();

            let pendentes = listaPrevia.filter(p => !carrinho.some(c => c.nome.toLowerCase() === p.toLowerCase()));
            const totalPendentes = pendentes.length;

            if (termoBusca) {
                pendentes = pendentes.filter(p => p.toLowerCase().includes(termoBusca));
            }

            if (totalPendentes > 0) {
                painelPendentes.classList.remove('hidden');
                badgePendentes.innerText = totalPendentes;

                if (pendentes.length === 0 && termoBusca) {
                    divPendentes.innerHTML = '<p class="text-center text-muted" style="margin-top: 12px; font-size: 0.875rem;">Nenhum item encontrado</p>';
                } else {
                    divPendentes.innerHTML = pendentes.map(item => `
                        <span class="chip-pendente" onclick="selecionarPendente('${item.replace(/'/g, "\\'")}')">
                            ${item}
                        </span>
                    `).join('');
                }
            } else {
                painelPendentes.classList.add('hidden');
            }
        };

        window.selecionarPendente = (nomeItem) => {
            document.getElementById('input-nome').value = nomeItem;
            document.getElementById('input-qtd').value = 1;
            document.getElementById('input-preco').focus();

            if (ultimosPrecos[nomeItem]) {
                mostrarNotificacao(`Último preço: R$ ${ultimosPrecos[nomeItem].toFixed(2).replace('.', ',')}`, 'neutro', 'info');
            }
        };

        // Autocomplete Compras
        const inputNome = document.getElementById('input-nome');
        const listaSugestoes = document.getElementById('lista-sugestoes');
        const inputPreco = document.getElementById('input-preco');

        inputNome.addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            listaSugestoes.innerHTML = '';
            if (termo.length < 1) { listaSugestoes.classList.add('hidden'); return; }
            const sugestoes = Array.from(produtosConhecidos).filter(p => p.toLowerCase().includes(termo)).slice(0, 10);
            if (sugestoes.length > 0) {
                listaSugestoes.classList.remove('hidden');
                sugestoes.forEach(produto => {
                    const div = document.createElement('div');
                    div.classList.add('item-sugestao');
                    div.innerText = produto;
                    div.onclick = () => {
                        inputNome.value = produto;
                        listaSugestoes.classList.add('hidden');
                        inputPreco.focus();
                        verificarHistoricoPreco(produto, parseFloat(inputPreco.value));
                    };
                    listaSugestoes.appendChild(div);
                });
            } else { listaSugestoes.classList.add('hidden'); }
        });

        // Autocomplete Editor
        const inputItemLista = document.getElementById('input-item-lista');
        const listaSugestoesEditor = document.getElementById('lista-sugestoes-editor');

        inputItemLista.addEventListener('input', (e) => {
            const termo = e.target.value.toLowerCase();
            listaSugestoesEditor.innerHTML = '';
            if (termo.length < 1) { listaSugestoesEditor.classList.add('hidden'); return; }
            const sugestoes = Array.from(produtosConhecidos).filter(p => p.toLowerCase().includes(termo)).slice(0, 10);
            if (sugestoes.length > 0) {
                listaSugestoesEditor.classList.remove('hidden');
                sugestoes.forEach(produto => {
                    const div = document.createElement('div');
                    div.classList.add('item-sugestao');
                    div.innerText = produto;
                    div.onclick = () => {
                        inputItemLista.value = produto;
                        listaSugestoesEditor.classList.add('hidden');
                        inputItemLista.focus();
                    };
                    listaSugestoesEditor.appendChild(div);
                });
            } else { listaSugestoesEditor.classList.add('hidden'); }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.input-group')) {
                listaSugestoes.classList.add('hidden');
                listaSugestoesEditor.classList.add('hidden');
            }
        });

        const verificarHistoricoPreco = (nome, precoAtual) => {
            if (!precoAtual) return;
            const nomeKey = Object.keys(ultimosPrecos).find(k => k.toLowerCase() === nome.toLowerCase());
            if (nomeKey) {
                const ultimoPreco = ultimosPrecos[nomeKey];
                const diff = precoAtual - ultimoPreco;
                if (diff > 0.05) mostrarNotificacao(`Mais caro! Você pagou R$ ${ultimoPreco.toFixed(2).replace('.', ',')} na última vez`, 'negativo', 'trending_up');
                else if (diff < -0.05) mostrarNotificacao(`Mais barato! Você pagou R$ ${ultimoPreco.toFixed(2).replace('.', ',')} na última vez`, 'positivo', 'trending_down');
            }
        };

        const mostrarNotificacao = (msg, tipo, icone = 'info') => {
            const container = document.getElementById('container-notificacoes');
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `<span class="material-icons">${icone}</span><span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        // Navegação e Eventos
        document.getElementById('btn-criar-lista').addEventListener('click', () => {
            document.getElementById('tela-inicial').classList.add('hidden');
            document.getElementById('tela-editor-lista').classList.remove('hidden');
            renderizarListaPreviaEditor();
        });

        document.getElementById('btn-salvar-lista').addEventListener('click', () => {
            salvarEstadoLocal();
            document.getElementById('tela-editor-lista').classList.add('hidden');
            document.getElementById('tela-inicial').classList.remove('hidden');
            if (listaPrevia.length > 0) {
                mostrarNotificacao(`Lista salva com ${listaPrevia.length} itens`, 'positivo', 'check_circle');
            }
        });

        document.getElementById('btn-add-item-lista').addEventListener('click', () => {
            const item = inputItemLista.value.trim();
            if (item) {
                listaPrevia.push(item);
                produtosConhecidos.add(item);
                salvarEstadoLocal();
                inputItemLista.value = '';
                inputItemLista.focus();
                renderizarListaPreviaEditor();
            }
        });

        inputItemLista.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('btn-add-item-lista').click();
            }
        });

        window.removerItemPrevia = (idx) => {
            listaPrevia.splice(idx, 1);
            salvarEstadoLocal();
            renderizarListaPreviaEditor();
        }

        const renderizarListaPreviaEditor = () => {
            const div = document.getElementById('lista-previa-itens');
            if (listaPrevia.length === 0) {
                div.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">list_alt</span>
                        <p>Sua lista está vazia</p>
                    </div>
                `;
                return;
            }
            div.innerHTML = listaPrevia.map((item, i) => `
                <div class="item-lista">
                    <div class="item-info">
                        <div class="item-nome">${item}</div>
                    </div>
                    <button class="btn-remove" onclick="removerItemPrevia(${i})">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            `).join('');
        };

        document.getElementById('btn-iniciar').addEventListener('click', () => {
            const valorInput = parseFloat(document.getElementById('orcamento-inicial').value);
            if (valorInput) orcamento = valorInput;
            salvarEstadoLocal();
            document.getElementById('tela-inicial').classList.add('hidden');
            document.getElementById('tela-compras').classList.remove('hidden');
            atualizarUI();
        });

        document.getElementById('btn-adicionar').addEventListener('click', () => {
            const nome = document.getElementById('input-nome').value.trim();
            const qtd = parseFloat(document.getElementById('input-qtd').value) || 1;
            const preco = parseFloat(document.getElementById('input-preco').value);

            if (nome && preco) {
                carrinho.push({ nome, qtd, preco, total: qtd * preco });
                produtosConhecidos.add(nome);
                ultimosPrecos[nome] = preco;
                salvarEstadoLocal();
                document.getElementById('input-nome').value = '';
                document.getElementById('input-preco').value = '';
                document.getElementById('input-qtd').value = 1;
                document.getElementById('input-nome').focus();
                atualizarUI();
                mostrarNotificacao(`${nome} adicionado ao carrinho`, 'positivo', 'check_circle');
            } else {
                mostrarNotificacao('Preencha o nome e o preço do produto', 'negativo', 'warning');
            }
        });

        inputPreco.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('btn-adicionar').click();
            }
        });

        document.getElementById('btn-finalizar').addEventListener('click', async () => {
            if (carrinho.length === 0) {
                mostrarNotificacao('Carrinho vazio', 'negativo', 'warning');
                return;
            }
            if (!confirm("Deseja finalizar a compra?")) return;

            const total = carrinho.reduce((sum, item) => sum + item.total, 0);
            try {
                await addDoc(collection(db, "compras_finalizadas"), {
                    data: Timestamp.now(),
                    total: total,
                    itens: carrinho
                });
                mostrarNotificacao('Compra finalizada com sucesso!', 'positivo', 'check_circle');
                limparEstadoLocal();
                listaPrevia = [];
                setTimeout(() => location.reload(), 1500);
            } catch (e) {
                mostrarNotificacao('Erro ao finalizar: ' + e.message, 'negativo', 'error');
            }
        });

        document.getElementById('btn-cancelar').addEventListener('click', () => {
            if (confirm("Tem certeza que deseja cancelar tudo?")) {
                limparEstadoLocal();
                location.reload();
            }
        });

        // Inicialização
        (async () => {
            carregarEstadoLocal();
            const q = query(collection(db, "compras_finalizadas"), orderBy("data", "desc"));
            const snap = await getDocs(q);
            const histDiv = document.getElementById('lista-historico');

            if (snap.empty) {
                histDiv.innerHTML = `
                    <div class="empty-state">
                        <span class="material-icons empty-state-icon">receipt_long</span>
                        <p>Nenhuma compra registrada ainda</p>
                    </div>
                `;
            } else {
                histDiv.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.itens) {
                        d.itens.forEach(i => {
                            produtosConhecidos.add(i.nome);
                            if (!ultimosPrecos[i.nome]) ultimosPrecos[i.nome] = i.preco;
                        });
                    }
                    const dataFormatada = d.data.toDate().toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric'
                    });
                    histDiv.innerHTML += `
                        <div class="historico-card" onclick='abrirModal(${JSON.stringify(d.itens)}, ${d.total})'>
                            <div class="historico-data">
                                <span class="material-icons">event</span>
                                <span>${dataFormatada}</span>
                            </div>
                            <div class="historico-total">R$ ${d.total.toFixed(2).replace('.', ',')}</div>
                        </div>
                    `;
                });
            }
        })();

        // Modal Logic
        const modal = document.getElementById('modal-cupom');
        window.abrirModal = (itens, total) => {
            document.getElementById('conteudo-cupom').innerHTML = itens.map(i => `
                <div class="linha-cupom">
                    <span>${i.nome} ${i.qtd}x</span>
                    <span>R$ ${i.total.toFixed(2).replace('.', ',')}</span>
                </div>
            `).join('');
            document.getElementById('total-cupom').innerText = `TOTAL: R$ ${total.toFixed(2).replace('.', ',')}`;
            modal.classList.remove('hidden');
        };

        document.querySelector('.close-modal').onclick = () => modal.classList.add('hidden');
        modal.onclick = (e) => {
            if (e.target === modal) modal.classList.add('hidden');
        };
    </script>
</body>

</html>